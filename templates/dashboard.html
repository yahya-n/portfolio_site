{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-5 mt-4">
    <div class="row">
        <!-- Offcanvas toggle for small screens -->
        <div class="col-12 d-md-none mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Dashboard</h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar" title="Menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button id="themeToggle" class="btn btn-outline-secondary" title="Toggle theme">
                        <i class="fas fa-adjust"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar: offcanvas for mobile, fixed for md+ -->
        <div class="col-md-3 col-lg-2 d-none d-md-block">
            <aside class="position-sticky top-0 pt-3">
                <div class="card glass-card border-0 shadow-sm">
                    <div class="card-body p-2">
                        <nav class="nav flex-column nav-pills" id="v-pills-tab" role="tablist"
                            aria-orientation="vertical">
                            <button class="nav-link active text-start mb-2 rounded-3 px-3" id="v-pills-analytics-tab"
                                data-bs-toggle="pill" data-bs-target="#v-pills-analytics" type="button" role="tab"
                                aria-controls="v-pills-analytics" aria-selected="true"><i
                                    class="fas fa-chart-line me-2"></i> Analytics</button>
                            <button class="nav-link text-start mb-2 rounded-3 px-3" id="v-pills-profile-tab"
                                data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab"
                                aria-controls="v-pills-profile"><i class="fas fa-user me-2"></i> Profile</button>
                            <button class="nav-link text-start mb-2 rounded-3 px-3" id="v-pills-skills-tab"
                                data-bs-toggle="pill" data-bs-target="#v-pills-skills" type="button" role="tab"
                                aria-controls="v-pills-skills"><i class="fas fa-code me-2"></i> Skills</button>
                            <button class="nav-link text-start mb-2 rounded-3 px-3" id="v-pills-projects-tab"
                                data-bs-toggle="pill" data-bs-target="#v-pills-projects" type="button" role="tab"
                                aria-controls="v-pills-projects"><i class="fas fa-project-diagram me-2"></i>
                                Projects</button>
                            <button class="nav-link text-start mb-2 rounded-3 px-3" id="v-pills-certs-tab"
                                data-bs-toggle="pill" data-bs-target="#v-pills-certs" type="button" role="tab"
                                aria-controls="v-pills-certs"><i class="fas fa-certificate me-2"></i>
                                Certifications</button>
                            <button class="nav-link text-start mb-2 rounded-3 px-3" id="v-pills-contact-tab"
                                data-bs-toggle="pill" data-bs-target="#v-pills-contact" type="button" role="tab"
                                aria-controls="v-pills-contact"><i class="fas fa-envelope me-2"></i> Contact</button>
                            <a href="{{ url_for('logout') }}" id="logoutBtn"
                                class="nav-link text-start mt-3 text-danger rounded-3 px-3"><i
                                    class="fas fa-sign-out-alt me-2"></i> Logout</a>
                        </nav>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Offcanvas Sidebar (mobile) -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar"
            aria-labelledby="offcanvasSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasSidebarLabel">Menu</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                    aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <nav class="nav flex-column nav-pills" id="v-pills-tab-mobile" role="tablist"
                    aria-orientation="vertical">
                    <button class="nav-link active text-start mb-2 rounded-3" id="v-pills-analytics-tab-mobile"
                        data-bs-toggle="pill" data-bs-target="#v-pills-analytics" type="button" role="tab"><i
                            class="fas fa-chart-line me-2"></i> Analytics</button>
                    <button class="nav-link text-start mb-2 rounded-3" id="v-pills-profile-tab-mobile"
                        data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab"><i
                            class="fas fa-user me-2"></i> Profile</button>
                    <button class="nav-link text-start mb-2 rounded-3" id="v-pills-skills-tab-mobile"
                        data-bs-toggle="pill" data-bs-target="#v-pills-skills" type="button" role="tab"><i
                            class="fas fa-code me-2"></i> Skills</button>
                    <button class="nav-link text-start mb-2 rounded-3" id="v-pills-projects-tab-mobile"
                        data-bs-toggle="pill" data-bs-target="#v-pills-projects" type="button" role="tab"><i
                            class="fas fa-project-diagram me-2"></i> Projects</button>
                    <button class="nav-link text-start mb-2 rounded-3" id="v-pills-certs-tab-mobile"
                        data-bs-toggle="pill" data-bs-target="#v-pills-certs" type="button" role="tab"><i
                            class="fas fa-certificate me-2"></i> Certifications</button>
                    <button class="nav-link text-start mb-2 rounded-3" id="v-pills-contact-tab-mobile"
                        data-bs-toggle="pill" data-bs-target="#v-pills-contact" type="button" role="tab"><i
                            class="fas fa-envelope me-2"></i> Contact</button>
                    <a href="{{ url_for('logout') }}" id="logoutBtnMobile"
                        class="nav-link text-start mt-3 text-danger rounded-3"><i class="fas fa-sign-out-alt me-2"></i>
                        Logout</a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h3 mb-0 d-none d-md-block">Dashboard</h1>
                <!-- Desktop theme toggle -->
                <div class="d-none d-md-flex align-items-center">
                    <button id="themeToggleDesktop" class="btn btn-outline-secondary me-2" title="Toggle theme">
                        <i class="fas fa-adjust"></i>
                    </button>
                    <button id="newItemHint" class="btn btn-sm btn-success d-none">Saved</button>
                </div>
            </div>

            <div class="tab-content" id="v-pills-tabContent">
                <!-- Analytics -->
                <div class="tab-pane fade show active" id="v-pills-analytics" role="tabpanel"
                    aria-labelledby="v-pills-analytics-tab">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card glass-card h-100 shadow-sm p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Daily Visits</h5>
                                    <small class="text-muted">last 30 days</small>
                                </div>
                                <canvas id="dailyVisitsChart" height="140" aria-label="Daily visits chart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card glass-card h-100 shadow-sm p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Page Views</h5>
                                    <small class="text-muted">by page</small>
                                </div>
                                <canvas id="pageViewsChart" height="140" aria-label="Page views chart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card glass-card h-100 shadow-sm p-3">
                                <h5 class="mb-2">Section Views</h5>
                                <canvas id="sectionViewsChart" height="140" aria-label="Section views"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card glass-card h-100 shadow-sm p-3">
                                <h5 class="mb-2">Interactions</h5>
                                <canvas id="interactionsChart" height="140"
                                    aria-label="Interaction events chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile -->
                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
                    <div class="card glass-card shadow-sm p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h4 class="mb-0">Edit Profile</h4>
                            <small class="text-muted">Updates are saved to your JSON file</small>
                        </div>
                        <form method="POST" enctype="multipart/form-data" id="profileForm" novalidate>
                            <input type="hidden" name="update_profile" value="1">
                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <label class="form-label small">Name</label>
                                    <input type="text" class="form-control" name="name" value="{{ data.profile.name }}"
                                        required>
                                </div>
                                <div class="col-lg-6">
                                    <label class="form-label small">Title</label>
                                    <input type="text" class="form-control" name="title"
                                        value="{{ data.profile.title }}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Intro (Hero)</label>
                                    <textarea class="form-control" name="intro"
                                        rows="2">{{ data.profile.intro }}</textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Bio (About)</label>
                                    <textarea class="form-control" name="bio" rows="4">{{ data.profile.bio }}</textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label small">Profile Image</label>
                                    <div class="d-flex gap-2">
                                        <div class="flex-shrink-0">
                                            <img id="profilePreview"
                                                src="{{ data.profile.image or url_for('static', filename='img/placeholder-profile.png') }}"
                                                alt="profile preview" class="rounded"
                                                style="height:72px; width:72px; object-fit:cover;">
                                        </div>
                                        <div class="flex-grow-1">
                                            <input type="file" class="form-control form-control-sm mb-2"
                                                name="image_file" accept="image/*" id="imageFileInput">
                                            <input type="text" class="form-control form-control-sm" name="image"
                                                value="{{ data.profile.image }}" placeholder="Or image URL">
                                            <small class="text-muted">Upload or paste image URL</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label small">Resume</label>
                                    <input type="file" class="form-control form-control-sm mb-2" name="resume_file"
                                        accept=".pdf">
                                    <input type="text" class="form-control form-control-sm" name="resume_link"
                                        value="{{ data.profile.resume_link }}" placeholder="Or resume link">
                                    <small class="text-muted">Upload a PDF or provide a link</small>
                                </div>

                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary px-4">Save Profile</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Education Section -->
                    <div class="card glass-card shadow-sm p-4 mt-4">
                        <h4 class="mb-3">Education</h4>

                        <!-- Add New Education -->
                        <div class="mb-4">
                            <h5 class="h6 text-muted mb-3">Add New Education</h5>
                            <form method="POST" id="addEducationForm">
                                <input type="hidden" name="add_education" value="1">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-control-sm" name="new_edu_degree"
                                            placeholder="Degree" required>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-control-sm"
                                            name="new_edu_institution" placeholder="Institution" required>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm" name="new_edu_year"
                                            placeholder="Year (e.g. 2020-2024)" required>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="submit" class="btn btn-success btn-sm w-100"><i
                                                class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Edit Existing Education -->
                        <div>
                            <h5 class="h6 text-muted mb-3">Edit Existing</h5>
                            <form method="POST" id="updateEducationForm">
                                <input type="hidden" name="update_education" value="1">
                                <div class="d-flex flex-column gap-3">
                                    {% if data.education %}
                                    {% for edu in data.education %}
                                    <div class="row g-2 align-items-center">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm" name="edu_degree"
                                                value="{{ edu.degree }}" placeholder="Degree">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm"
                                                name="edu_institution" value="{{ edu.institution }}"
                                                placeholder="Institution">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="text" class="form-control form-control-sm" name="edu_year"
                                                value="{{ edu.year }}" placeholder="Year">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-outline-danger btn-sm w-100"
                                                onclick="confirmDelete('{{ loop.index0 }}', 'education')"><i
                                                    class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    <div class="d-flex justify-content-end mt-2">
                                        <button type="submit" class="btn btn-primary btn-sm px-3">Save
                                            Education</button>
                                    </div>
                                    {% else %}
                                    <p class="text-muted small fst-italic">No education entries yet.</p>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Skills -->
                <div class="tab-pane fade" id="v-pills-skills" role="tabpanel" aria-labelledby="v-pills-skills-tab">
                    <div class="card glass-card shadow-sm p-4">
                        <h4 class="mb-3">Edit Skills</h4>
                        <form method="POST" id="skillsForm">
                            <input type="hidden" name="update_skills" value="1">
                            <div class="mb-3">
                                <label class="form-label small">Skills (one per line or comma separated)</label>
                                <textarea class="form-control" name="skills"
                                    rows="6">{{ data.skills | join('\n') }}</textarea>
                                <small class="text-muted">Tip: include skill and optionally level like `Python:
                                    90`</small>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary px-4">Save Skills</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Projects -->
                <div class="tab-pane fade" id="v-pills-projects" role="tabpanel" aria-labelledby="v-pills-projects-tab">
                    <div class="card glass-card shadow-sm p-4 mb-4">
                        <h4 class="mb-3">Add New Project</h4>
                        <form method="POST" enctype="multipart/form-data" id="addProjectForm">
                            <input type="hidden" name="add_project" value="1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">Title</label>
                                    <input type="text" class="form-control" name="new_project_title" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Technologies (comma separated)</label>
                                    <input type="text" class="form-control" name="new_project_tech" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Description</label>
                                    <textarea class="form-control" name="new_project_desc" rows="2" required></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">GitHub Link</label>
                                    <input type="text" class="form-control" name="new_project_github" value="#">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Image</label>
                                    <input type="file" class="form-control form-control-sm"
                                        name="new_project_image_file" accept="image/*" id="newProjectImageFile">
                                    <input type="text" class="form-control form-control-sm mt-2"
                                        name="new_project_image" placeholder="Or image URL">
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="checkbox" name="new_project_featured"
                                            id="newProjectFeatured">
                                        <label class="form-check-label small" for="newProjectFeatured">
                                            Show on Home Page (Featured)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-success px-4">Add Project</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="card glass-card shadow-sm p-4">
                        <h4 class="mb-3">Edit Existing Projects</h4>
                        <form method="POST" enctype="multipart/form-data" id="updateProjectsForm">
                            <input type="hidden" name="update_projects" value="1">
                            <div id="projects-container" class="row g-3">
                                {% for project in data.projects %}
                                <div class="col-12">
                                    <div class="card border-0 bg-transparent p-3 shadow-sm">
                                        <div class="row g-2 align-items-center">
                                            <div class="col-md-3">
                                                <img src="{{ project.image }}" class="img-fluid rounded"
                                                    alt="Project image" style="max-height:120px; object-fit:cover;">
                                                <input type="file" class="form-control form-control-sm mt-2"
                                                    name="project_image_file_{{ loop.index0 }}" accept="image/*">
                                                <input type="text" class="form-control form-control-sm mt-2"
                                                    name="project_image_{{ loop.index0 }}" value="{{ project.image }}"
                                                    placeholder="Image URL">
                                            </div>
                                            <div class="col-md-9">
                                                <div class="mb-2">
                                                    <label class="form-label small">Title</label>
                                                    <input type="text" class="form-control"
                                                        name="project_title_{{ loop.index0 }}"
                                                        value="{{ project.title }}">
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label small">Description</label>
                                                    <textarea class="form-control" name="project_desc_{{ loop.index0 }}"
                                                        rows="2">{{ project.description }}</textarea>
                                                </div>
                                                <div class="row g-2">
                                                    <div class="col-md-6">
                                                        <label class="form-label small">Technologies</label>
                                                        <input type="text" class="form-control"
                                                            name="project_tech_{{ loop.index0 }}"
                                                            value="{{ project.technologies }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label small">GitHub Link</label>
                                                        <input type="text" class="form-control"
                                                            name="project_github_{{ loop.index0 }}"
                                                            value="{{ project.github_link }}">
                                                    </div>
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox"
                                                        name="project_featured_{{ loop.index0 }}"
                                                        id="projectFeatured{{ loop.index0 }}" {% if project.featured
                                                        %}checked{% endif %}>
                                                    <label class="form-check-label small"
                                                        for="projectFeatured{{ loop.index0 }}">
                                                        Show on Home Page
                                                    </label>
                                                </div>
                                                <div class="mt-2 d-flex justify-content-end">
                                                    <button class="btn btn-outline-danger btn-sm me-2" type="button"
                                                        onclick="confirmDelete('{{ loop.index0 }}','project')">Delete</button>
                                                    <!-- If you want a reorder feature later, add move up/down here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button type="submit" class="btn btn-primary px-4">Save Projects</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Certifications -->
                <div class="tab-pane fade" id="v-pills-certs" role="tabpanel" aria-labelledby="v-pills-certs-tab">
                    <div class="card glass-card shadow-sm p-4 mb-4">
                        <h4 class="mb-3">Add New Certification</h4>
                        <form method="POST" id="addCertForm">
                            <input type="hidden" name="add_cert" value="1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">Title</label>
                                    <input type="text" class="form-control" name="new_cert_title" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Organization</label>
                                    <input type="text" class="form-control" name="new_cert_org" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Date</label>
                                    <input type="text" class="form-control" name="new_cert_date"
                                        placeholder="e.g. 2024">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Link</label>
                                    <input type="text" class="form-control" name="new_cert_link" value="#">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Description</label>
                                    <textarea class="form-control" name="new_cert_desc" rows="2"></textarea>
                                </div>
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-success px-4">Add Certification</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="card glass-card shadow-sm p-4">
                        <h4 class="mb-3">Edit Certifications</h4>
                        <form method="POST" id="updateCertsForm">
                            <input type="hidden" name="update_certs" value="1">
                            <div id="certs-container" class="row g-3">
                                {% for cert in data.certifications %}
                                <div class="col-12">
                                    <div class="card border-0 bg-transparent p-3 shadow-sm">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label small">Title</label>
                                                <input type="text" class="form-control"
                                                    name="cert_title_{{ loop.index0 }}" value="{{ cert.title }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">Organization</label>
                                                <input type="text" class="form-control"
                                                    name="cert_org_{{ loop.index0 }}" value="{{ cert.organization }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">Date</label>
                                                <input type="text" class="form-control"
                                                    name="cert_date_{{ loop.index0 }}" value="{{ cert.date }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">Link</label>
                                                <input type="text" class="form-control"
                                                    name="cert_link_{{ loop.index0 }}" value="{{ cert.link }}">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small">Description</label>
                                                <textarea class="form-control" name="cert_desc_{{ loop.index0 }}"
                                                    rows="2">{{ cert.description }}</textarea>
                                            </div>
                                            <div class="col-12 d-flex justify-content-end mt-2">
                                                <button class="btn btn-outline-danger btn-sm" type="button"
                                                    onclick="confirmDelete('{{ loop.index0 }}','cert')">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button type="submit" class="btn btn-primary px-4">Save Certifications</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Contact -->
                <div class="tab-pane fade" id="v-pills-contact" role="tabpanel" aria-labelledby="v-pills-contact-tab">
                    <div class="card glass-card shadow-sm p-4">
                        <h4 class="mb-3">Edit Contact Info</h4>
                        <form method="POST" id="contactForm">
                            <input type="hidden" name="update_contact" value="1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">Email</label>
                                    <input type="email" class="form-control" name="email"
                                        value="{{ data.contact.email }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">LinkedIn</label>
                                    <input type="text" class="form-control" name="linkedin"
                                        value="{{ data.contact.linkedin }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">GitHub</label>
                                    <input type="text" class="form-control" name="github"
                                        value="{{ data.contact.github }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Twitter</label>
                                    <input type="text" class="form-control" name="twitter"
                                        value="{{ data.contact.twitter }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Instagram</label>
                                    <input type="text" class="form-control" name="instagram"
                                        value="{{ data.contact.instagram }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Location</label>
                                    <input type="text" class="form-control" name="location"
                                        value="{{ data.contact.location }}">
                                </div>
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary px-4">Save Contact Info</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



<script id="analytics-data" type="application/json">
        {{ analytics | tojson | safe}}
</script>
<script>

    var analytics = JSON.parse(document.getElementById('analytics-data').textContent);

    // ---------- Theme Toggle ----------
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('dashboardTheme', theme);
    }
    const savedTheme = localStorage.getItem('dashboardTheme') || 'light';
    applyTheme(savedTheme);

    document.querySelectorAll('#themeToggle, #themeToggleDesktop').forEach(btn => {
        btn.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            applyTheme(current === 'light' ? 'dark' : 'light');
        });
    });

    // ---------- Confirm Delete helper (frontend only) ----------
    function confirmDelete(index, type) {
        if (!confirm('Are you sure you want to delete this ' + type + '? This action cannot be undone.')) return;
        // Create a hidden input to signal deletion on POST
        const formSelector = type === 'project' ? '#updateProjectsForm' : type === 'education' ? '#updateEducationForm' : '#updateCertsForm';
        const form = document.querySelector(formSelector);
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `delete_${type}_${index}`;
        input.value = '1';
        form.appendChild(input);
        form.submit();
    }

    // ---------- Image preview for profile -->
    const profileFileInput = document.getElementById('imageFileInput');
    if (profileFileInput) {
        profileFileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                document.getElementById('profilePreview').src = reader.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // ---------- New project image preview (optional) ----------
    const newProjInput = document.getElementById('newProjectImageFile');
    if (newProjInput) {
        newProjInput.addEventListener('change', () => {
            // we don't preview new project here to keep layout simple, but you can add preview logic similar to profilePreview
        });
    }

    // ---------- Smooth focus on invalid inputs after submit ----------
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', (e) => {
            // let server handle validation; this only scrolls to the first invalid input if present
            const invalid = form.querySelector(':invalid');
            if (invalid) {
                invalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    });

    // ---------- Confirm logout ----------
    document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
        if (!confirm('Logout from admin?')) e.preventDefault();
    });
    document.getElementById('logoutBtnMobile')?.addEventListener('click', (e) => {
        if (!confirm('Logout from admin?')) e.preventDefault();
    });

    // ---------- Charts ----------
    const chartColors = {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#6c5ce7',
        accent: '#a29bfe',
        green: '#00b894'
    };

    // Daily Visits
    new Chart(document.getElementById('dailyVisitsChart'), {
        type: 'line',
        data: {
            labels: Object.keys(analytics.daily_visits || {}),
            datasets: [{
                label: 'Visits',
                data: Object.values(analytics.daily_visits || {}),
                borderColor: chartColors.primary,
                backgroundColor: 'rgba(108,92,231,0.08)',
                fill: true,
                tension: 0.35,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
    });

    // Page Views
    const pageMapping = {
        '/': 'Home',
        '/projects': 'Projects',
        '/contact': 'Contact',
        '/download_resume': 'Resume',
        '/admin/login': 'Admin Login',
        '/admin/dashboard': 'Dashboard'
    };
    const pageLabels = Object.keys(analytics.page_views || {}).map(p => pageMapping[p] || p);
    new Chart(document.getElementById('pageViewsChart'), {
        type: 'bar',
        data: {
            labels: pageLabels,
            datasets: [{
                label: 'Views',
                data: Object.values(analytics.page_views || {}),
                backgroundColor: chartColors.accent
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} views` } } }
        }
    });

    // Section Views (doughnut)
    new Chart(document.getElementById('sectionViewsChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(analytics.section_views || {}),
            datasets: [{
                data: Object.values(analytics.section_views || {}),
                backgroundColor: ['#ff7675', '#74b9ff', '#55efc4', '#ffeaa7', '#a29bfe', '#fd79a8']
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    // Interactions
    new Chart(document.getElementById('interactionsChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(analytics.interactions || {}),
            datasets: [{
                label: 'Count',
                data: Object.values(analytics.interactions || {}),
                backgroundColor: chartColors.green
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
</script>

<!-- Local styles -->
<style>
    :root {
        --bg: #f6f7fb;
        --card: #ffffffcc;
        --glass: rgba(255, 255, 255, 0.6);
        --primary: #6c5ce7;
        --muted: #6c757d;
        --text: #222;
        --border: rgba(0, 0, 0, 0.06);
    }

    [data-theme="dark"] {
        --bg: #0f1724;
        --card: rgba(20, 24, 31, 0.5);
        --glass: rgba(255, 255, 255, 0.04);
        --primary: #7c5cff;
        --muted: #9aa4b2;
        --text: #e6eef6;
        --border: rgba(255, 255, 255, 0.04);
    }

    body {
        background: var(--bg);
        color: var(--text);
        transition: background 0.25s linear, color 0.25s linear;
    }

    .glass-card {
        background: var(--card);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid var(--border);
        backdrop-filter: blur(6px);
    }

    .nav-pills .nav-link {
        color: var(--muted);
    }

    .nav-pills .nav-link.active {
        background: linear-gradient(90deg, var(--primary), #9b8cff);
        color: #fff;
        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.15);
    }

    .card h4,
    .card h5 {
        color: var(--text);
    }

    .form-label.small {
        font-size: .8rem;
        color: var(--muted);
    }

    .btn-primary {
        background: var(--primary);
        border: none;
    }

    .btn-outline-secondary {
        border-color: var(--border);
        color: var(--muted);
        background: transparent;
    }

    .btn-outline-danger {
        border-color: rgba(255, 0, 0, 0.12);
        color: #ff6b6b;
    }

    .img-fluid.rounded {
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    /* Responsive tweaks */
    @media (max-width: 767px) {
        .glass-card {
            padding: .75rem;
        }
    }

    /* Form Control Styling */
    .form-control {
        background-color: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: var(--text);
        transition: all 0.3s ease;
    }

    .form-control:focus {
        background-color: #fff;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
    }

    [data-theme="dark"] .form-control {
        background-color: rgba(20, 24, 31, 0.6);
        border-color: rgba(255, 255, 255, 0.1);
        color: #e6eef6;
    }

    [data-theme="dark"] .form-control:focus {
        background-color: rgba(20, 24, 31, 0.9);
        border-color: var(--primary);
    }

    [data-theme="dark"] .form-control::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }
</style>
{% endblock %}